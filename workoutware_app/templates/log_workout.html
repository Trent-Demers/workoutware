<!--
    Template: Log Workout

    Purpose:
    - Provide all functionality for creating, editing, viewing, and managing workout sessions.
    - Display workout templates, suggestions, recent sessions, and allow inline editing of session names.

    Major Functional Sections:
    1. New Workout Session Form
        • User inputs: session_name, session_date, start_time, bodyweight, optional goal link.
        • Submits via POST to: create_session

    2. Suggested Exercises (Optional)
        • suggestions: exercises user hasn’t trained recently.

    3. Workout Templates
        • templates: list of saved session templates (is_template = True)
        • Actions:
            - Use Template → opens modal requiring new workout name
            - Edit Template → go to add_exercises_to_session
            - Delete Template

        • Uses JavaScript modal:
            - showRenameModal(templateId, templateName)
            - closeRenameModal()

    4. Recent Workout Sessions
        • recent_sessions: user’s active and completed sessions.
        • Each item:
            - Editable workout name (inline with JS + fetch POST)
            - View / Continue workout page
            - Mark Completed
            - Delete workout

        • Inline rename:
            Functions:
                editWorkoutName(id)
                saveWorkoutName(id)
                getCookie(name)

    5. Modal for Using Templates
        • renameModal allows setting a new session name before creating a workout from a template.

    Context Variables Expected:
        today → default date
        active_goals → list of user goals still active
        templates → list of workout templates
        suggestions → list of exercises recommended
        recent_sessions → recent workouts with attributes:
            .session_id
            .session_name
            .session_date
            .completed

    Notes:
    - All logic is controlled by Django URL patterns like create_session, add_exercises_to_session, etc.
    - No personal data beyond user-specific sessions is displayed.
    - Inline editing uses Fetch API with CSRF token retrieval for safety.
-->
{% load static %}
<!DOCTYPE html>
<html>
 <head>
  <link href="{% static 'stylesheets/workoutware.css' %}" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  {% load static %}
  <title>
   Log Workout
  </title>
  <style>
   .suggestion-box {
    background: var(--bg-card);
    padding: 25px;
    border-radius: 16px;
    margin: 20px 0;
    border-left: 5px solid var(--warning);
   }
   .suggestion-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
   }
   .suggestion-badge {
    background: rgba(253, 203, 110, 0.2);
    color: var(--warning);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9em;
   }
   .template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 20px 0;
   }
   .template-card {
    background: var(--bg-card);
    padding: 25px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    transition: var(--transition-normal);
   }
   .template-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
   }
   .template-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
   }
   .btn-use {
    background: var(--primary);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    flex-grow: 1;
    font-weight: 600;
   }
   .btn-edit-template, .btn-delete-template {
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
   }
   .workout-list {
    padding: 0;
   }
   .workout-item {
    background: var(--bg-card);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    border: 1px solid var(--border-color);
   }
   .workout-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
   }
   .btn-view, .btn-edit-workout, .btn-save-workout, .btn-delete-workout {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85em;
   }
   .btn-view {
    background: var(--primary);
    color: white;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    white-space: normal;
    text-align: center;
    padding: 12px 16px;
    font-size: 1.2rem; 
    gap: 0.5rem;
   }
   .btn-edit-workout {
    background: rgba(116, 185, 255, 0.2);
    color: var(--info);
    border: 1px solid var(--info);
   }
   .btn-save-workout {
    background: var(--success);
    color: white;
   }
   .btn-delete-workout {
    background: rgba(255, 107, 107, 0.2);
    color: var(--danger);
    border: 1px solid var(--danger);
   }
   .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
   }
   .modal-content {
    background: var(--bg-card);
    padding: 30px;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    border: 1px solid var(--border-color);
   }
   .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
   }
   .modal-buttons button {
    flex: 1;
   }
  </style>
 </head>
 <body>
 <div class="container-wrapper">
  <h1 class="fade-in">
   <i class="fas fa-dumbbell"></i> Log Workout
  </h1>
  <div class="nav-links fade-in">
   <a href="{% url 'home' %}">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
   </a>
  </div>
  <h2 class="fade-in">
   <i class="fas fa-play-circle"></i> Start New Workout Session
  </h2>
  <form action="{% url 'create_session' %}" method="post">
   {% csrf_token %}
   <div class="form-container fade-in">
    <label for="session_name">
     <i class="fas fa-tag"></i> Workout Name
    </label>
    <input id="session_name" name="session_name" placeholder="e.g., Push Day" required="" type="text"/>
    <label for="session_date">
     <i class="far fa-calendar"></i> Date
    </label>
    <input id="session_date" name="session_date" required="" type="date" value="{{ today|date:'Y-m-d' }}"/>
    <label for="start_time">
     <i class="far fa-clock"></i> Start Time
    </label>
    <input id="start_time" name="start_time" type="time"/>
    <label for="bodyweight">
     <i class="fas fa-weight-scale"></i> Your Weight Today (lbs)
    </label>
    <input id="bodyweight" name="bodyweight" placeholder="Optional" step="0.1" type="number"/>
    <label for="goal_id">
     <i class="fas fa-bullseye"></i> Count this workout toward a goal (optional)
    </label>
    <select id="goal_id" name="goal_id">
     <option value="">
      -- None --
     </option>
     {% for goal in active_goals %}
     <option value="{{ goal.goal_id }}">
      {{ goal.goal_description }}
     </option>
     {% endfor %}
    </select>
    <button type="submit">
     <i class="fas fa-rocket"></i> Create Workout Session
    </button>
   </div>
  </form>
  <hr/>
  {% if suggestions %}
  <div class="suggestion-box fade-in">
   <h3>
    <i class="fas fa-lightbulb"></i> Recommended Exercises
   </h3>
   <p style="color: var(--text-secondary);">
    You haven't trained these exercises recently:
   </p>
   <div class="suggestion-list">
    {% for ex in suggestions %}
    <span class="suggestion-badge">
     {{ ex.name }}
    </span>
    {% endfor %}
   </div>
  </div>
  {% endif %}
    
    {% if templates %}
  <h2 class="fade-in">
   <i class="fas fa-clipboard-list"></i> Workout Templates
  </h2>
  <div class="template-grid">
   {% for template in templates %}
   <div class="template-card fade-in">
    <h4 style="margin-top: 0;">
     <i class="fas fa-file-alt"></i> {{ template.session_name }}
    </h4>
    <p style="font-size: 0.9em; color: var(--text-muted);">
     Saved template for quick workouts
    </p>
    <div class="template-actions">
     <button class="btn-use" onclick="showRenameModal({{ template.session_id }}, '{{ template.session_name }}')">
      <i class="fas fa-play"></i> Use
     </button>
     <a class="btn-edit-template" href="{% url 'add_exercises_to_session' template.session_id %}" title="Edit Template">
      <i class="fas fa-edit"></i>
     </a>
     <form action="{% url 'delete_template' template.session_id %}" method="post" onsubmit="return confirm('Delete this template?');" style="display: inline;">
      {% csrf_token %}
      <button class="btn-delete-template" title="Delete Template" type="submit">
       <i class="fas fa-trash"></i>
      </button>
     </form>
    </div>
   </div>
   {% endfor %}
  </div>
  <hr/>
  {% endif %}
  <h2 class="fade-in">
   <i class="fas fa-history"></i> Recent Workout Sessions
  </h2>
  {% if recent_sessions %}
  <ul class="workout-list">
   {% for session in recent_sessions %}
   <li class="workout-item fade-in">
    <div class="workout-info">
     <strong id="workout-name-{{ session.session_id }}">
      <i class="fas fa-dumbbell"></i> {{ session.session_name }}
     </strong>
     - {{ session.session_date|date:"M d, Y" }}
                    {% if session.completed %}
     <span class="badge badge-success" style="margin-left: 10px;">
      <i class="fas fa-check"></i> Completed
     </span>
     {% else %}
     <span class="badge badge-warning" style="margin-left: 10px;">
      <i class="fas fa-hourglass-half"></i> In Progress
     </span>
     {% endif %}
     <input id="edit-name-{{ session.session_id }}" style="display: none; padding: 8px; margin-left: 10px;" type="text" value="{{ session.session_name }}"/>
    </div>
    <div class="workout-actions">
     <button class="btn-edit-workout" id="edit-btn-{{ session.session_id }}" onclick="editWorkoutName({{ session.session_id }})">
      <i class="fas fa-edit"></i> Edit
     </button>
     <button class="btn-save-workout" id="save-btn-{{ session.session_id }}" onclick="saveWorkoutName({{ session.session_id }})" style="display: none;">
      <i class="fas fa-save"></i> Save
     </button>
     <a class="btn-view" href="{% url 'add_exercises_to_session' session.session_id %}">
      <i class="fas fa-eye"></i> View
     </a>
     <form action="{% url 'complete_workout' session.session_id %}" method="post" style="display:inline;">
      {% csrf_token %}
      <button class="btn-save-workout" type="submit" {% if session.completed %}disabled style="opacity: 0.6; cursor: default;"{% endif %}>
       <i class="fas fa-check-circle"></i> {% if session.completed %}Done{% else %}Complete{% endif %}
      </button>
     </form>
     <form action="{% url 'delete_workout' session.session_id %}" method="post" onsubmit="return confirm('Delete this workout? This cannot be undone.');" style="display: inline;">
      {% csrf_token %}
      <button class="btn-delete-workout" type="submit">
       <i class="fas fa-trash"></i>
      </button>
     </form>
    </div>
   </li>
   {% endfor %}
  </ul>
  {% else %}
  <div class="empty-state fade-in">
   <i class="fas fa-dumbbell"></i>
   <p>No workouts logged yet. Start your first one above!</p>
  </div>
  {% endif %}
  <!-- Rename Template Modal -->
  <div class="modal" id="renameModal">
   <div class="modal-content">
    <h3>
     <i class="fas fa-edit"></i> Name Your Workout
    </h3>
    <form id="renameForm" method="post">
     {% csrf_token %}
     <label for="newSessionName">
      <i class="fas fa-tag"></i> Workout Name
     </label>
     <input id="newSessionName" name="session_name" placeholder="Enter workout name" required="" type="text"/>
     <div class="modal-buttons">
      <button type="submit">
       <i class="fas fa-plus"></i> Create
      </button>
      <button onclick="closeRenameModal()" type="button" class="btn-secondary">
       <i class="fas fa-times"></i> Cancel
      </button>
     </div>
    </form>
   </div>
  </div>
  <script>
   function editWorkoutName(sessionId) {
       document.getElementById('workout-name-' + sessionId).style.display = 'none';
       document.getElementById('edit-name-' + sessionId).style.display = 'inline-block';
       document.getElementById('edit-btn-' + sessionId).style.display = 'none';
       document.getElementById('save-btn-' + sessionId).style.display = 'inline-block';
   }

   async function saveWorkoutName(sessionId) {
       const newName = document.getElementById('edit-name-' + sessionId).value;
       
       const response = await fetch(`/workout/${sessionId}/rename/`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/x-www-form-urlencoded',
               'X-CSRFToken': getCookie('csrftoken')
           },
           body: `session_name=${encodeURIComponent(newName)}`
       });

       if (response.ok) {
           document.getElementById('workout-name-' + sessionId).innerHTML = '<i class="fas fa-dumbbell"></i> ' + newName;
           document.getElementById('workout-name-' + sessionId).style.display = 'inline';
           document.getElementById('edit-name-' + sessionId).style.display = 'none';
           document.getElementById('edit-btn-' + sessionId).style.display = 'inline-block';
           document.getElementById('save-btn-' + sessionId).style.display = 'none';
       } else {
           alert('Error saving name. Please try again.');
       }
   }

   function getCookie(name) {
       let cookieValue = null;
       if (document.cookie && document.cookie !== '') {
           const cookies = document.cookie.split(';');
           for (let i = 0; i < cookies.length; i++) {
               const cookie = cookies[i].trim();
               if (cookie.substring(0, name.length + 1) === (name + '=')) {
                   cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                   break;
               }
           }
       }
       return cookieValue;
   }

   function showRenameModal(templateId, templateName) {
       const modal = document.getElementById('renameModal');
       const form = document.getElementById('renameForm');
       const input = document.getElementById('newSessionName');
       
       form.action = '/template/' + templateId + '/use/';
       input.value = templateName.replace(' (Template)', '');
       
       modal.style.display = 'flex';
   }

   function closeRenameModal() {
       document.getElementById('renameModal').style.display = 'none';
   }

   window.onclick = function(event) {
       const modal = document.getElementById('renameModal');
       if (event.target == modal) {
           closeRenameModal();
       }
   }
  </script>
  </div>
</body>
</html>

<!--
    Template: Progress & Trends Dashboard

    Purpose:
    - Display a full analytics dashboard for user workout progression, body trends, validations, and auto-generated recommendations.
    - Combine tables, charts, and summaries into a single unified progress view.
    - Provide interactive charts using Chart.js, including auto-generated top-exercise charts and user-selected exercise trends.

    Expected Context Variables:
    --------------------------------
    exercise_trends:
        A JSON-serializable dictionary structured as:
        {
            "Exercise Name": {
                "dates": [...],
                "max_weights": [...]
            },
            ...
        }
        Used to automatically generate “Top 5 Exercise Progression” charts.

    user_exercises:
        List of (exercise_id, exercise_name) pairs for the dropdown that loads
        custom trend charts via AJAX (fetch to /progress/exercise/<id>/).

    bodyweight_trend:
        Dictionary containing:
        {
            "dates": [...],
            "weights": [...]
        }
        Used for the bodyweight trend line chart.

    weight_increase_recs:
        List of recommendation objects with attribute `.message`
        Suggests where users may increase weight based on recent repo performance.

    neglected_muscle_group_recs:
        Object containing:
            • groups: list of muscles flagged
            • lookback_days: integer
            • messages: list of HTML-formatted suggestion strings

    progress_data:
        Weekly aggregated statistics per exercise. Each entry has:
            • date
            • exercise_id (FK → Exercise)
            • period_type ("weekly", “monthly”, etc.)
            • max_weight
            • avg_weight
            • total_volume
            • workout_count

    validations:
        Recent input validation logs, where each record provides:
            • timestamp
            • exercise_id (FK → Exercise)
            • input_weight
            • expected_max
            • flagged_as (outlier, new_pr, normal, suspicious_low, first_time)
            • user_action (optional: confirmed, corrected, logged)
        These rows generate color-coded badges.

    Template Features Summary:
    --------------------------------
    1. Navigation links to Home, Workout Logging, and Body Stats Logging.
    2. Auto-generated “Top 5 Exercises” progression charts rendered on load.
    3. Dynamic trend explorer:
        - User picks an exercise from a dropdown.
        - Page fetches JSON from /progress/exercise/<id>/ and renders:
            • Max weight progression
            • Average reps per set
            • Total volume per workout
        - Old charts safely destroyed to avoid duplicates.
    4. Bodyweight trend chart.
    5. Auto-generated training recommendations.
    6. Weekly aggregated progress table.
    7. Validation monitoring table.

    Notes:
    --------------------------------
    - Uses Chart.js 3.9.1.
    - Requires backend API endpoint for /progress/exercise/<id>/ returning JSON.
    - All context variables must be JSON-safe before rendering.
    - This template does not modify state; all POST/PUT operations occur elsewhere.

-->
{% load static %}
<!DOCTYPE html>
<html>
 <head>
  <link href="{% static 'stylesheets/workoutware.css' %}" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <title>
   Progress &amp; Trends
  </title>
 </head>
 <body>
 <div class="container-wrapper">
  <h1 class="fade-in">
   <i class="fas fa-chart-line"></i> Your Progress &amp; Trends
  </h1>
  <div class="nav-links fade-in">
   <a href="{% url 'home' %}">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
   </a>
   <a href="{% url 'log_workout' %}">
    <i class="fas fa-dumbbell"></i> Log Workout
   </a>
   <a href="{% url 'log_body_stats' %}">
    <i class="fas fa-ruler-combined"></i> Log Body Stats
   </a>
  </div>
  <div class="section-header fade-in">
   <h2>
    <i class="fas fa-chart-area"></i> Top Exercise Progression
   </h2>
   <p>
    Your top 5 exercises by total volume
   </p>
  </div>
  <div class="charts-grid fade-in" id="top-exercise-charts">
   <!-- Top 5 charts inserted here by JavaScript -->
  </div>
  <div class="section-header fade-in">
   <h2>
    <i class="fas fa-search"></i> Custom Exercise Progression
   </h2>
   <p>
    Select any exercise to view detailed progression
   </p>
  </div>
  <div class="chart-controls form-container fade-in">
   <label for="exerciseSelect">
    <i class="fas fa-list"></i> Select Exercise
   </label>
   <select id="exerciseSelect" onchange="loadCustomChart()">
    <option value="">
     -- Choose an exercise --
    </option>
    {% for ex_id, ex_name in user_exercises %}
    <option value="{{ ex_id }}">
     {{ ex_name }}
    </option>
    {% endfor %}
   </select>
  </div>
  <div id="customChartsContainer" style="display: none;">
   <div class="chart-container fade-in">
    <h3 id="chartTitle">
     Loading...
    </h3>
    <canvas id="weightChart">
    </canvas>
   </div>
   <div class="chart-container fade-in">
    <h3>
     <i class="fas fa-repeat"></i> Average Reps Per Set
    </h3>
    <canvas id="repsChart">
    </canvas>
   </div>
   <div class="chart-container fade-in">
    <h3>
     <i class="fas fa-weight-hanging"></i> Total Volume Per Workout
    </h3>
    <canvas id="volumeChart">
    </canvas>
   </div>
  </div>
  <div class="section-header fade-in">
   <h2>
    <i class="fas fa-weight-scale"></i> Bodyweight Trend
   </h2>
  </div>
  <div class="chart-container fade-in">
   <canvas id="bodyweight-chart">
   </canvas>
  </div>
  <div class="section-header fade-in">
   <h2>
    <i class="fas fa-lightbulb"></i> Workout Recommendations
   </h2>
   <p>
    Auto-generated suggestions based on your recent training
   </p>
  </div>
  <div class="chart-container fade-in">
   {% if weight_increase_recs or neglected_muscle_group_recs.groups %}
            {% if weight_increase_recs %}
   <h3>
    <i class="fas fa-arrow-up"></i> Suggested Weight Increases
   </h3>
   <ul style="padding-left: 20px;">
    {% for rec in weight_increase_recs %}
    <li style="list-style: disc; margin-bottom: 8px; color: var(--text-secondary);">
     {{ rec.message }}
    </li>
    {% endfor %}
   </ul>
   {% else %}
   <p style="color: var(--text-muted);">
    <i class="fas fa-info-circle"></i> No weight increase recommendations yet – keep hitting your target reps!
   </p>
   {% endif %}

            {% if neglected_muscle_group_recs.groups %}
   <h3 style="margin-top: 25px;">
    <i class="fas fa-exclamation-triangle"></i> Neglected Muscle Groups (last {{ neglected_muscle_group_recs.lookback_days }} days)
   </h3>
   <ul style="padding-left: 20px;">
    {% for msg in neglected_muscle_group_recs.messages %}
    <li style="list-style: disc; margin-bottom: 8px; color: var(--text-secondary);">
     {{ msg|safe }}
    </li>
    {% endfor %}
   </ul>
   {% else %}
   <p style="color: var(--text-muted);">
    <i class="fas fa-check-circle"></i> No clearly neglected muscle groups detected recently.
   </p>
   {% endif %}
        {% else %}
   <div class="empty-state">
    <i class="fas fa-brain"></i>
    <p>No recommendations yet – complete a few more workouts to unlock insights.</p>
   </div>
   {% endif %}
  </div>
  <div class="section-header fade-in">
   <h2>
    <i class="fas fa-calendar-check"></i> Weekly Progress Metrics
   </h2>
   <p>
    Your strength data aggregated by week
   </p>
  </div>
  {% if progress_data %}
  <table class="progress-table fade-in">
   <thead>
    <tr>
     <th>
      <i class="far fa-calendar"></i> Date
     </th>
     <th>
      <i class="fas fa-dumbbell"></i> Exercise
     </th>
     <th>
      <i class="fas fa-clock"></i> Period
     </th>
     <th>
      <i class="fas fa-arrow-up"></i> Max Weight
     </th>
     <th>
      <i class="fas fa-balance-scale"></i> Avg Weight
     </th>
     <th>
      <i class="fas fa-cube"></i> Total Volume
     </th>
     <th>
      <i class="fas fa-hashtag"></i> Workouts
     </th>
    </tr>
   </thead>
   <tbody>
    {% for p in progress_data %}
    <tr>
     <td>
      {{ p.date|date:"M d, Y" }}
     </td>
     <td>
      <strong>
       {{ p.exercise_id.name }}
      </strong>
     </td>
     <td>
      {{ p.period_type|capfirst }}
     </td>
     <td>
      {% if p.max_weight %}{{ p.max_weight }} lbs{% else %}N/A{% endif %}
     </td>
     <td>
      {% if p.avg_weight %}{{ p.avg_weight|floatformat:1 }} lbs{% else %}N/A{% endif %}
     </td>
     <td>
      {% if p.total_volume %}{{ p.total_volume|floatformat:0 }} lbs{% else %}N/A{% endif %}
     </td>
     <td>
      {{ p.workout_count }}
     </td>
    </tr>
    {% endfor %}
   </tbody>
  </table>
  {% else %}
  <div class="empty-state fade-in">
   <i class="fas fa-chart-bar"></i>
   <p>No progress data yet. Complete a few workouts to see your trends!</p>
  </div>
  {% endif %}
  <div class="section-header fade-in">
   <h2>
    <i class="fas fa-shield-check"></i> Recent Validation Checks
   </h2>
   <p>
    Real-time data accuracy monitoring
   </p>
  </div>
  {% if validations %}
  <table class="validation-table fade-in">
   <thead>
    <tr>
     <th>
      <i class="fas fa-clock"></i> Timestamp
     </th>
     <th>
      <i class="fas fa-dumbbell"></i> Exercise
     </th>
     <th>
      <i class="fas fa-weight-hanging"></i> Input Weight
     </th>
     <th>
      <i class="fas fa-chart-line"></i> Expected Max
     </th>
     <th>
      <i class="fas fa-flag"></i> Status
     </th>
     <th>
      <i class="fas fa-bolt"></i> Action
     </th>
    </tr>
   </thead>
   <tbody>
    {% for v in validations %}
    <tr>
     <td>
      {{ v.timestamp|date:"M d, Y H:i" }}
     </td>
     <td>
      <strong>
       {{ v.exercise_id.name }}
      </strong>
     </td>
     <td>
      {{ v.input_weight }} lbs
     </td>
     <td>
      {% if v.expected_max %}{{ v.expected_max }} lbs{% else %}N/A{% endif %}
     </td>
     <td>
      <span class="flag-badge badge-{{ v.flagged_as }}">
       {% if v.flagged_as == 'outlier' %}<i class="fas fa-exclamation-triangle"></i> Outlier
                            {% elif v.flagged_as == 'new_pr' %}<i class="fas fa-trophy"></i> New PR!
                            {% elif v.flagged_as == 'normal' %}<i class="fas fa-check"></i> Normal
                            {% elif v.flagged_as == 'suspicious_low' %}<i class="fas fa-arrow-down"></i> Low
                            {% elif v.flagged_as == 'first_time' %}<i class="fas fa-star"></i> First Time
                            {% else %}{{ v.flagged_as|capfirst }}{% endif %}
      </span>
     </td>
     <td>
      {{ v.user_action|default:"Logged"|capfirst }}
     </td>
    </tr>
    {% endfor %}
   </tbody>
  </table>
  {% else %}
  <div class="empty-state fade-in">
   <i class="fas fa-shield-check"></i>
   <p>No validation history yet. Log some workouts to see smart validation in action!</p>
  </div>
  {% endif %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js">
  </script>
  <script>
   // Parse data from Django context
        const exerciseTrends = {{ exercise_trends|safe }};
        const bodyweightTrend = {{ bodyweight_trend|safe }};
        
        // Chart color scheme matching new CSS
        const chartColors = {
            primary: '#00b894',
            secondary: '#00cec9',
            accent: '#e17055',
            info: '#74b9ff',
            gridColor: 'rgba(0, 184, 148, 0.1)',
            textColor: '#8b949e'
        };
        
        // PART 1: Create TOP 5 exercise charts (auto-display)
        const topChartsContainer = document.getElementById('top-exercise-charts');
        
        for (const [exerciseName, data] of Object.entries(exerciseTrends)) {
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container fade-in';
            
            const title = document.createElement('h3');
            title.innerHTML = '<i class="fas fa-chart-line"></i> ' + exerciseName;
            chartDiv.appendChild(title);
            
            const canvas = document.createElement('canvas');
            chartDiv.appendChild(canvas);
            topChartsContainer.appendChild(chartDiv);
            
            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Max Weight (lbs)',
                        data: data.max_weights,
                        borderColor: chartColors.primary,
                        backgroundColor: 'rgba(0, 184, 148, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: chartColors.primary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: chartColors.textColor }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: chartColors.gridColor },
                            ticks: {
                                color: chartColors.textColor,
                                callback: function(value) {
                                    return value + ' lbs';
                                }
                            }
                        },
                        x: {
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        }
                    }
                }
            });
        }
        
        // PART 2: Custom exercise dropdown charts
        let weightChartInstance = null;
        let repsChartInstance = null;
        let volumeChartInstance = null;
        
        async function loadCustomChart() {
            const exerciseId = document.getElementById('exerciseSelect').value;
            if (!exerciseId) {
                document.getElementById('customChartsContainer').style.display = 'none';
                return;
            }
            
            // Fetch data from API
            const response = await fetch(`/progress/exercise/${exerciseId}/`);
            const data = await response.json();
            
            const exerciseName = document.getElementById('exerciseSelect').selectedOptions[0].text;
            document.getElementById('chartTitle').innerHTML = '<i class="fas fa-dumbbell"></i> ' + exerciseName + ' - Max Weight Progression';
            document.getElementById('customChartsContainer').style.display = 'block';
            
            // Destroy old charts
            if (weightChartInstance) weightChartInstance.destroy();
            if (repsChartInstance) repsChartInstance.destroy();
            if (volumeChartInstance) volumeChartInstance.destroy();
            
            // Weight chart
            weightChartInstance = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Max Weight (lbs)',
                        data: data.max_weights,
                        borderColor: chartColors.primary,
                        backgroundColor: 'rgba(0, 184, 148, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: false,
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        },
                        x: {
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: chartColors.textColor } }
                    }
                }
            });
            
            // Reps chart
            repsChartInstance = new Chart(document.getElementById('repsChart'), {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Avg Reps',
                        data: data.avg_reps,
                        borderColor: chartColors.info,
                        backgroundColor: 'rgba(116, 185, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        },
                        x: {
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: chartColors.textColor } }
                    }
                }
            });
            
            // Volume chart
            volumeChartInstance = new Chart(document.getElementById('volumeChart'), {
                type: 'bar',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Total Volume (lbs)',
                        data: data.total_volume,
                        backgroundColor: 'rgba(225, 112, 85, 0.5)',
                        borderColor: chartColors.accent,
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        },
                        x: {
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: chartColors.textColor } }
                    }
                }
            });
        }
        
        // PART 3: Bodyweight chart
        if (bodyweightTrend.dates.length > 0) {
            new Chart(document.getElementById('bodyweight-chart'), {
                type: 'line',
                data: {
                    labels: bodyweightTrend.dates,
                    datasets: [{
                        label: 'Bodyweight (lbs)',
                        data: bodyweightTrend.weights,
                        borderColor: chartColors.secondary,
                        backgroundColor: 'rgba(0, 206, 201, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: chartColors.secondary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: chartColors.textColor }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: chartColors.gridColor },
                            ticks: {
                                color: chartColors.textColor,
                                callback: function(value) {
                                    return value + ' lbs';
                                }
                            }
                        },
                        x: {
                            grid: { color: chartColors.gridColor },
                            ticks: { color: chartColors.textColor }
                        }
                    }
                }
            });
        }
  </script>
  </div>
</body>
</html>
